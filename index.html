import { useState } from 'react'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { Input } from '@/components/ui/input'
import { Button } from '@/components/ui/button'
import { Badge } from '@/components/ui/badge'

type Message = {
  role: 'user' | 'assistant'
  content: string
}

const AI_RESPONSES: Record<string, string> = {
  // Thermodynamics
  'q=mÂ·cÂ·Î”t': 'La fÃ³rmula Q = mÂ·cÂ·Î”T calcula el calor sensible transferido. Donde:\nâ€¢ m = masa (kg)\nâ€¢ c = calor especÃ­fico (J/kgÂ·K)\nâ€¢ Î”T = cambio de temperatura (K)\n\nEjemplo: Para calentar 1kg de agua (c=4186 J/kgÂ·K) en 10K: Q = 1 Ã— 4186 Ã— 10 = 41,860 J',
  'calor': 'El calor es energÃ­a en trÃ¡nsito entre sistemas con diferentes temperaturas. Se mide en Joules (J) y fluye de caliente a frÃ­o. Hay dos tipos:\nâ€¢ Calor sensible: cambia temperatura (Q=mÂ·cÂ·Î”T)\nâ€¢ Calor latente: cambia fase (Q=mÂ·L)',
  'temperatura': 'La temperatura mide la energÃ­a cinÃ©tica promedio de las partÃ­culas. Escalas:\nâ€¢ Celsius (Â°C): punto de congelaciÃ³n agua = 0Â°C\nâ€¢ Kelvin (K): escala absoluta, 0K = -273.15Â°C\nâ€¢ Fahrenheit (Â°F): usado en EEUU\n\nConversiones:\nK = Â°C + 273.15\nÂ°F = (Â°C Ã— 9/5) + 32',

  // Electrostatics
  'coulomb': 'La Ley de Coulomb describe la fuerza entre cargas:\n\nF = kÂ·|qâ‚Â·qâ‚‚|/rÂ²\n\nDonde:\nâ€¢ k = 8.99Ã—10â¹ NÂ·mÂ²/CÂ² (constante de Coulomb)\nâ€¢ qâ‚, qâ‚‚ = cargas (Coulombs)\nâ€¢ r = distancia (metros)\n\nLa fuerza es atractiva si las cargas tienen signos opuestos, repulsiva si son del mismo signo.',
  'potencial': 'El potencial elÃ©ctrico (V) es la energÃ­a potencial por unidad de carga:\n\nV = kÂ·q/r\n\nMedido en Voltios (V = J/C). Las cargas se mueven espontÃ¡neamente de mayor a menor potencial. El trabajo para mover una carga: W = qÂ·Î”V',
  'campo elÃ©ctrico': 'El campo elÃ©ctrico (E) es la fuerza por unidad de carga:\n\nE = kÂ·q/rÂ² (N/C)\n\nLas lÃ­neas de campo:\nâ€¢ Salen de cargas positivas\nâ€¢ Entran a cargas negativas\nâ€¢ Nunca se cruzan\nâ€¢ La densidad indica intensidad',

  // Circuits
  'ohm': 'La Ley de Ohm relaciona voltaje, corriente y resistencia:\n\nV = IÂ·R\n\nDonde:\nâ€¢ V = voltaje (Voltios)\nâ€¢ I = corriente (Amperios)\nâ€¢ R = resistencia (Ohmios, Î©)\n\nSerie: R_total = Râ‚ + Râ‚‚ + ...\nParalelo: 1/R_total = 1/Râ‚ + 1/Râ‚‚ + ...',
  'corriente': 'La corriente elÃ©ctrica es el flujo de carga por unidad de tiempo:\n\nI = Q/t (Amperios)\n\nCC (Corriente Continua): flujo constante\nCA (Corriente Alterna): flujo sinusoidal\n\nPotencia: P = VÂ·I = IÂ²Â·R = VÂ²/R',
  'ac': 'La corriente alterna (AC) varÃ­a sinusoidalmente:\n\nV(t) = V_maxÂ·sin(2Ï€ft)\n\nDonde:\nâ€¢ V_max = voltaje mÃ¡ximo\nâ€¢ f = frecuencia (Hz)\nâ€¢ t = tiempo (s)\n\nValor RMS (eficaz): V_rms = V_max/âˆš2 â‰ˆ 0.707Â·V_max',

  // Optics
  'snell': 'La Ley de Snell describe la refracciÃ³n:\n\nnâ‚Â·sin(Î¸â‚) = nâ‚‚Â·sin(Î¸â‚‚)\n\nDonde:\nâ€¢ n = Ã­ndice de refracciÃ³n\nâ€¢ Î¸ = Ã¡ngulo respecto a la normal\n\nSi nâ‚‚ > nâ‚: el rayo se acerca a la normal\nSi nâ‚ > nâ‚‚: el rayo se aleja de la normal',
  'reflexiÃ³n': 'La reflexiÃ³n ocurre cuando la luz rebota en una superficie:\n\nLey de reflexiÃ³n: Î¸áµ¢ = Î¸áµ£\n\nReflexiÃ³n interna total ocurre cuando:\nâ€¢ Luz va de medio mÃ¡s denso a menos denso\nâ€¢ Ãngulo > Ã¡ngulo crÃ­tico: Î¸c = arcsin(nâ‚‚/nâ‚)',
  'espectro': 'El espectro visible va de 380nm (violeta) a 780nm (rojo):\n\nâ€¢ Violeta: 380-450nm\nâ€¢ Azul: 450-495nm\nâ€¢ Verde: 495-570nm\nâ€¢ Amarillo: 570-590nm\nâ€¢ Naranja: 590-620nm\nâ€¢ Rojo: 620-780nm\n\nEnergia del fotÃ³n: E = hc/Î»',

  // General
  'unidades': 'Unidades SI importantes en fÃ­sica:\n\nâ€¢ Longitud: metro (m)\nâ€¢ Masa: kilogramo (kg)\nâ€¢ Tiempo: segundo (s)\nâ€¢ Corriente: amperio (A)\nâ€¢ Temperatura: kelvin (K)\nâ€¢ EnergÃ­a: joule (J)\nâ€¢ Potencia: watt (W)\nâ€¢ Carga: coulomb (C)\nâ€¢ Voltaje: volt (V)',
  'default': 'Soy tu asistente de fÃ­sica (Beta). Puedo ayudarte con:\n\nğŸ“š Explicaciones de fÃ³rmulas\nğŸ§® GuÃ­a en cÃ¡lculos\nğŸ’¡ Conceptos fundamentales\n\nPregÃºntame sobre: temperatura, calor, Coulomb, potencial, Ohm, corriente, Snell, reflexiÃ³n, espectro, etc.'
}

export default function AIPanel() {
  const [messages, setMessages] = useState<Message[]>([
    { role: 'assistant', content: AI_RESPONSES.default }
  ])
  const [input, setInput] = useState('')

  const findResponse = (query: string): string => {
    const lowerQuery = query.toLowerCase()

    // Check for exact or partial matches
    for (const [key, response] of Object.entries(AI_RESPONSES)) {
      if (lowerQuery.includes(key.toLowerCase())) {
        return response
      }
    }

    // Check for common variations
    if (lowerQuery.includes('temperatura') || lowerQuery.includes('temp')) {
      return AI_RESPONSES.temperatura
    }
    if (lowerQuery.includes('calo')) {
      return AI_RESPONSES.calor
    }
    if (lowerQuery.includes('fuerza') && lowerQuery.includes('elect')) {
      return AI_RESPONSES.coulomb
    }
    if (lowerQuery.includes('resisten') || lowerQuery.includes('circuito')) {
      return AI_RESPONSES.ohm
    }
    if (lowerQuery.includes('refrac')) {
      return AI_RESPONSES.snell
    }
    if (lowerQuery.includes('reflect') || lowerQuery.includes('espejo')) {
      return AI_RESPONSES.reflexiÃ³n
    }
    if (lowerQuery.includes('luz') || lowerQuery.includes('color')) {
      return AI_RESPONSES.espectro
    }

    return 'No tengo informaciÃ³n especÃ­fica sobre eso aÃºn. Intenta preguntar sobre:\n\nâ€¢ FÃ³rmulas (Q=mÂ·cÂ·Î”T, Coulomb, Ohm, Snell)\nâ€¢ Conceptos (temperatura, calor, potencial, corriente)\nâ€¢ Unidades\n\nRecuerda que estoy en versiÃ³n Beta y mis respuestas son limitadas.'
  }

  const handleSend = () => {
    if (!input.trim()) return

    const userMessage: Message = { role: 'user', content: input }
    const response = findResponse(input)
    const assistantMessage: Message = { role: 'assistant', content: response }

    setMessages([...messages, userMessage, assistantMessage])
    setInput('')
  }

  const handleKeyPress = (e: React.KeyboardEvent) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault()
      handleSend()
    }
  }

  const quickQuestions = [
    'Â¿CÃ³mo aplico Q=mÂ·cÂ·Î”T?',
    'Â¿QuÃ© es la Ley de Coulomb?',
    'Â¿CÃ³mo funciona la Ley de Ohm?',
    'Â¿QuÃ© es la Ley de Snell?',
  ]

  return (
    <Card className="bg-slate-800/50 border-slate-700 backdrop-blur-sm h-[calc(100vh-12rem)] flex flex-col">
      <CardHeader className="border-b border-slate-700">
        <div className="flex items-center justify-between">
          <CardTitle className="text-emerald-400 flex items-center gap-2">
            Asistente IA
            <Badge variant="outline" className="bg-emerald-900/50 text-emerald-300 border-emerald-600">
              Beta
            </Badge>
          </CardTitle>
        </div>
        <p className="text-slate-400 text-xs mt-1">
          Respuestas predefinidas basadas en contexto
        </p>
      </CardHeader>

      <CardContent className="flex-1 flex flex-col p-4 overflow-hidden">
        {/* Messages */}
        <div className="flex-1 overflow-y-auto space-y-4 mb-4">
          {messages.map((msg, idx) => (
            <div
              key={idx}
              className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}
            >
              <div
                className={`max-w-[85%] rounded-lg p-3 ${
                  msg.role === 'user'
                    ? 'bg-emerald-600 text-white'
                    : 'bg-slate-700 text-slate-200'
                }`}
              >
                <div className="text-sm whitespace-pre-line">{msg.content}</div>
              </div>
            </div>
          ))}
        </div>

        {/* Quick Questions */}
        {messages.length === 1 && (
          <div className="mb-4 space-y-2">
            <div className="text-xs text-slate-400">Preguntas rÃ¡pidas:</div>
            <div className="grid grid-cols-1 gap-2">
              {quickQuestions.map((q, idx) => (
                <button
                  key={idx}
                  onClick={() => {
                    setInput(q)
                    setTimeout(() => handleSend(), 100)
                  }}
                  className="text-left text-xs p-2 bg-slate-700/50 hover:bg-slate-700 rounded border border-slate-600 text-slate-300 transition-colors"
                >
                  {q}
                </button>
              ))}
            </div>
          </div>
        )}

        {/* Input */}
        <div className="flex gap-2">
          <Input
            value={input}
            onChange={(e: React.ChangeEvent<HTMLInputElement>) => setInput(e.target.value)}
            onKeyPress={handleKeyPress}
            placeholder="Pregunta sobre fÃ­sica..."
            className="bg-slate-700 border-slate-600 text-white placeholder:text-slate-400"
          />
          <Button onClick={handleSend} className="bg-emerald-600 hover:bg-emerald-700">
            Enviar
          </Button>
        </div>
      </CardContent>
    </Card>
  )
}
